---
# Mandatory fields.
title: Create an Azure FUnction for ADT
titleSuffix: Azure Digital Twins
description: How to create an Azure Function that can be triggered by ADT and access ADT
author: cschorm
ms.author: cschorm # Microsoft employees only
ms.date: 3/17/2020
ms.topic: how-to
ms.service: digital-twins

# Optional fields. Don't forget to remove # if you need a field.
# ms.custom: can-be-multiple-comma-separated
# ms.reviewer: MSFT-alias-of-reviewer
# manager: MSFT-alias-of-manager-or-PM-counterpart
---

# Creating Azure Functions for ADT

To create an Azure Function for ADT, you need to follow these steps:

* Create an Azure Function app in Visual Studio
* Write an Azure FUnction with an Event Grid Trigger
* Add authentication code to the function to be able to access ADT 
* Deploy the Functions app to Azure
* Set up security access. In order for the Azure Function to receive an access token at runtime to access the service, we need to configure Managed Service Identity for the functions app.
* Subscribe the Azure Function to an Event Grid. This endpoint could be:
  * An Event Grid endpoint attached to ADT to process messages coming from ADT itself (such as property change messages, telemetry messages generated by twins in the tree, or life cycle messages)
  * The IoT system topics used by IoT Hub to send telemetry and other device events
  * An event grid receiving messages from other services

## Creating a Functions App with Visual Studio

In Visual Studio 2019, select File>New Project.

[![VS New Project](media/how-to-create-azfn/vs-new-azfn-project.png)](media/how-to-create-azfn/vs-new-azfn-project.png)

Search for the Azure Functions template and select "Next".

[![VS Configure Project](media/how-to-create-azfn/vs-azfn-project-config.png)](media/how-to-create-azfn/vs-azfn-project-config.png)

Specify a name for the functions app and click "Create"

[![VS New Project](media/how-to-create-azfn/vs-azfn-project-trigger.png)](media/how-to-create-azfn/vs-azfn-project-trigger.png)

Select the Event Grid Trigger and press Create.

## The Azure Function

The generated Azure Function will look as follows: 

```csharp
// Default URL for triggering event grid function in the local environment.
// http://localhost:7071/runtime/webhooks/EventGrid?functionName={functionname}
using System;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Host;
using Microsoft.Azure.EventGrid.Models;
using Microsoft.Azure.WebJobs.Extensions.EventGrid;
using Microsoft.Extensions.Logging;

namespace adtIngestFunctionSample
{
    public static class Function1
    {
        [FunctionName("Function1")]
        public static void Run([EventGridTrigger]EventGridEvent eventGridEvent, ILogger log)
        {
            log.LogInformation(eventGridEvent.Data.ToString());
        }
    }
}
```

### Running and Debugging Azure Functions

You can, at this point, compile and run the Azure Function. While Azure Functions eventually are intended to run in the cloud, you can also run and debug Azure FUnctions locally.

See [Azure Function Event Grid Trigger Local Debugging](https://docs.microsoft.com/en-us/azure/azure-functions/functions-debug-event-grid-trigger-local) for more information.

### Adding the ADT SDK to your Functions App
In [How to Use ADT APIs](how-to-use-apis.md) we explain how to generate the Azure ADT SDK using Autorest and compile it as a re-usable project.

To be able to access ADT from your Azure Function, add the ADT SDK project to the Functions app. YOu can do that by right-clicking on Dependencies in the Solution Explorer and selecting "Add Reference...".

Alternatively, you can also add the generated code from Autorest directly to the Functions app project.

Once you have added a reference to the project or added the classes, you can access the ADT Api after adding the following line to your project:

```csharp
using ADTApi;
```

### Setting up authentication against ADT
First, add: 
* The ADT app ID
* The URL for your ADT service instance 
* A variable to hold your ADT service client instance
to the functions project.

Also change the function signature to be asynchronous.

```csharp
namespace adtIngestFunctionSample
{
    public static class Function1
    {
        const string AdtAppId = "0b07f429-9f4b-4714-9392-cc5e8e80c8b0";
        const string AdtInstanceUrl = "<your-adt-instance-url>";
        static AzureDigitalTwinsAPIClient client;

        [FunctionName("Function1")]
        public static async Task Run([EventGridTrigger]EventGridEvent eventGridEvent, ILogger log)
        {
            log.LogInformation(eventGridEvent.Data.ToString());
        }
    }
}
```

Next, add an authentication function:
```csharp
public async static Task Authenticate(ILogger log)
{
    var azureServiceTokenProvider = new AzureServiceTokenProvider();
    string accessToken = await azureServiceTokenProvider.GetAccessTokenAsync(AdtAppId);

    var wc = new System.Net.Http.HttpClient();
    wc.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);

    try
    {
        TokenCredentials tk = new TokenCredentials(accessToken);
        client = new AzureDigitalTwinsAPIClient(tk)
        {
            BaseUri = new Uri(AdtInstanceUrl)
        };
        log.LogInformation($"ADT service client connection created.");
    }
    catch (Exception e)
    {
        log.LogError($"ADT service client connection failed.");
    }
}
```

The complete example:
```csharp
// Default URL for triggering event grid function in the local environment.
// http://localhost:7071/runtime/webhooks/EventGrid?functionName={functionname}
using System;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Host;
using Microsoft.Azure.EventGrid.Models;
using Microsoft.Azure.WebJobs.Extensions.EventGrid;
using Microsoft.Extensions.Logging;
using ADTApi;
using System.Threading.Tasks;
using Microsoft.Azure.Services.AppAuthentication;
using System.Net.Http.Headers;
using Microsoft.Rest;

namespace adtIngestFunctionSample
{
    public static class Function1
    {
        const string AdtAppId = "0b07f429-9f4b-4714-9392-cc5e8e80c8b0";
        const string AdtInstanceUrl = "<your-adt-instance-url>";
        static AzureDigitalTwinsAPIClient client;

        [FunctionName("Function1")]
        static async Task Run([EventGridTrigger]EventGridEvent eventGridEvent, ILogger log)
        {
            await Authenticate(log);
            log.LogInformation(eventGridEvent.Data.ToString());
            if (client!=null)
            {
                // Add your code here
            }
        }

        public async static Task Authenticate(ILogger log)
        {
            var azureServiceTokenProvider = new AzureServiceTokenProvider();
            string accessToken = await azureServiceTokenProvider.GetAccessTokenAsync(AdtAppId);

            var wc = new System.Net.Http.HttpClient();
            wc.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);

            try
            {
                TokenCredentials tk = new TokenCredentials(accessToken);
                client = new AzureDigitalTwinsAPIClient(tk)
                {
                    BaseUri = new Uri(AdtInstanceUrl)
                };
                log.LogInformation($"ADT service client connection created.");
            }
            catch (Exception e)
            {
                log.LogError($"ADT service client connection failed.");
            }
        }
    }
}
```

### Publish the Functions App
To publish the functions app to Azure, right click the functions project in solution explorer (not the solution) and select Publish().

The following tab will appear:

[![VS Publish Function](media/how-to-create-azfn/vs-azfn-publish.png)](media/how-to-create-azfn/vs-azfn-publish.png)

Select the desired Azure Functions plan (if in doubt, initially use the default consumption plan). Note that using Azure Functions will incur charges beyond ADT.

[![VS Publish Function](media/how-to-create-azfn/vs-azfn-publish2.png)](media/how-to-create-azfn/vs-azfn-publish2.png)

On the following page, enter the desired name for the new Functions app, a resource group, and other details.

## Setting Up Security
The Azure function skeleton shown above requires a bearer token to be passed to it in order to be able to authenticate with ADT. To make sure that this bearer token is passed, we need to set up [Managed Service Identity (MSI)](https://azure.microsoft.com/en-us/blog/keep-credentials-out-of-code-introducing-azure-ad-managed-service-identity/) for the functions app.

To set this up, go to the portal and navigate to your Functions app

[![VS Function MSI](media/how-to-create-azfn/vs-azfn-msi1.png)](media/how-to-create-azfn/vs-azfn-msi1.png)

In the Platform features tab, select Identity:

[![VS Function MSI](media/how-to-create-azfn/vs-azfn-msi2.png)](media/how-to-create-azfn/vs-azfn-msi2.png)

On the identity page, set the Status toggle to On. 