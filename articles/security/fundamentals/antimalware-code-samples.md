---
title: Microsoft Antimalware code samples for Azure | Microsoft Docs
description: Microsoft Antimalware code samples for Azure ARM VMs.
services: security
documentationcenter: na
author: terrylanfear
manager: rkarlin
editor: ''

ms.assetid: 265683c8-30d7-4f2b-b66c-5082a18f7a8b
ms.service: security
ms.subservice: security-fundamentals
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 10/23/2020
ms.author: terrylan
---
# Enable and configure Microsoft Antimalware for ARM virtual machines
You can enable and configure Microsoft Antimalware for Azure Resource Manager (ARM) VMs. This article provides code samples using PowerShell cmdlets.

## Deploy Microsoft Antimalware on ARM VMs

> [!NOTE]
> Before executing this code sample, you must uncomment the variables and provide appropriate values.

```powershell
# Script to add Microsoft Antimalware extension to Azure Resource Manager (IAAS V2) VM’s
# Specify your subscription ID
$subscriptionId= " SUBSCRIPTION ID HERE "
# specify location, resource group, and VM for the extension
$location = " LOCATION HERE " # eg., “Southeast Asia” or “Central US”
$resourceGroupName = " RESOURCE GROUP NAME HERE "
$vmName = " VM NAME HERE "
# Enable Antimalware with default policies
$settingString = ‘{"AntimalwareEnabled": true}’;
# Enable Antimalware with custom policies
# $settingString = ‘{
# "AntimalwareEnabled": true,
# "RealtimeProtectionEnabled": true,
# "ScheduledScanSettings": {
#                             "isEnabled": true,
#                             "day": 0,
#                             "time": 120,
#                             "scanType": "Quick"
#                             },
# "Exclusions": {
#            "Extensions": ".ext1,.ext2",
#                  "Paths":"",
#                  "Processes":"sampl1e1.exe, sample2.exe"
#             }            
#
# }’;
# Login to your Azure Resource Manager Account and select the Subscription to use
Login-AzureRmAccount

Select-AzureRmSubscription -SubscriptionId $subscriptionId
# retrieve the most recent version number of the extension
$allVersions= (Get-AzureRmVMExtensionImage -Location $location -PublisherName “Microsoft.Azure.Security” -Type “IaaSAntimalware”).Version
$versionString = $allVersions[($allVersions.count)-1].Split(“.”)[0] + “.” + $allVersions[($allVersions.count)-1].Split(“.”)[1]
# set the extension using prepared values
# ****—-Use this script till cmdlets address the -SettingsString format issue we observed ****—-
Set-AzureRmVMExtension -ResourceGroupName $resourceGroupName -Location $location -VMName $vmName -Name "IaaSAntimalware" -Publisher “Microsoft.Azure.Security” -ExtensionType “IaaSAntimalware” -TypeHandlerVersion $versionString -SettingString $settingString
```

## Add Microsoft Antimalware to Azure Service Fabric Clusters
Azure Service Fabric uses Azure VM Scale Set (VMSS) to create the Service Fabric Clusters. Presently the VMSS template used for creating the Service Fabric Clusters are not enabled with the Antimalware extension. Hence, Antimalware needs to be enabled separately on the VMSS. As you enable it on VMSS, all the nodes created under the VMSS inherit and get the extension automatically.

The code sample below, shows how you can enable IaaS Antimalware extension using the AzureRmVmss PS cmdlets.

> [!NOTE]
> Before executing this code sample, you must uncomment the variables and provide appropriate values.

```powershell
# Script to add Microsoft Antimalware extension to Azure Resource Manager (IAAS V2) VM’s
# Specify your subscription ID
$subscriptionId= "10c5d508-c599-42ff-85c4-c15b92f298b5"
# specify location, resource group, and VM for the extension
$location = "Central US" # eg., “Southeast Asia” or “Central US”
$resourceGroupName = "amtestrgjuly2018"
$vmName = "AMEXCLNTEST-04"
# Enable Antimalware with default policies
$settingString = ‘{"AntimalwareEnabled": true}’;

# Enable Antimalware with custom policies
# $settingString = ‘{
# "AntimalwareEnabled": true,
# "RealtimeProtectionEnabled": true,
# "ScheduledScanSettings": {
#                             "isEnabled": true,
#                             "day": 0,
#                             "time": 120,
#                             "scanType": "Quick"
#                             },
# "Exclusions": {
#            "Extensions": ".ext1,.ext2",
#                  "Paths":"",
#                  "Processes":"sampl1e1.exe, sample2.exe"
#             }            
# }’;

# Login to your Azure Resource Manager Account and select the Subscription to use
Login-AzureRmAccount

Select-AzureRmSubscription -SubscriptionId $subscriptionId
# retrieve the most recent version number of the extension
$allVersions= (Get-AzureRmVMExtensionImage -Location $location -PublisherName “Microsoft.Azure.Security” -Type “IaaSAntimalware”).Version
$versionString = $allVersions[($allVersions.count)-1].Split(“.”)[0] + “.” + $allVersions[($allVersions.count)-1].Split(“.”)[1]
# set the extension using prepared values
# ****—-Use this script till cmdlets address the -SettingsString format issue we observed ****—-
Set-AzureRmVMExtension -ResourceGroupName $resourceGroupName -Location $location -VMName $vmName -Name "IaaSAntimalware" -Publisher “Microsoft.Azure.Security” -ExtensionType “IaaSAntimalware” -TypeHandlerVersion $versionString -SettingString $settingString
```