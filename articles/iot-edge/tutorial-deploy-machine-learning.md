---
title: Tutorial deploy Azure Machine Learning to a device - Azure IoT Edge | Microsoft Docs
description: In this tutorial, you deploy Azure Machine Learning as a module to an edge device
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 02/21/2019
ms.topic: tutorial
ms.service: iot-edge
services: iot-edge
ms.custom: "mvc, seodec18"
---

# Tutorial: Deploy Azure Machine Learning as an IoT Edge module (preview)

You can use IoT Edge modules to deploy code that implements your business logic directly to your IoT Edge devices. This tutorial walks you through deploying an Azure Machine Learning module that predicts when a device fails based on simulated machine temperature data. For more information about Azure Machine Learning service on IoT Edge, see [Azure Machine Learning documentation](../machine-learning/service/how-to-deploy-to-iot.md).

The Azure Machine Learning module that you create in this tutorial reads the environmental data generated by your device and labels the messages as anomalous or not.

In this tutorial, you learn how to:

> [!div class="checklist"]
> * Create an Azure Machine Learning module
> * Push a module container to an Azure container registry
> * Deploy an Azure Machine Learning module to your IoT Edge device
> * View generated data

>[!NOTE]
>Azure Machine Learning modules on Azure IoT Edge are in public preview.

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]


## Prerequisites

An Azure IoT Edge device:

* You can use your development machine or a virtual machine as an Edge device by following the steps in the quickstart for [Linux](quickstart-linux.md) or [Windows devices](quickstart.md).
* The Azure Machine Learning module does not support ARM processors.

Cloud resources:

* A free or standard-tier [IoT Hub](../iot-hub/iot-hub-create-through-portal.md) in Azure.
* An Azure Machine Learning workspace. Follow the instructions in [Prepare to deploy models on IoT Edge](../machine-learning/service/how-to-deploy-to-iot.md) to create one.


### Disable process identification

>[!NOTE]
>
> While in preview, Azure Machine Learning does not support the process identification security feature enabled by default with IoT Edge.
> Below are the steps to disable it. This is however not suitable for use in production. These steps are only necessary on Linux, as you will have completed this during the Windows Edge runtime installation.

To disable process identification on your IoT edge device, you'll need to provide the ip address and port for **workload_uri** and **management_uri** in the **connect** section of the IoT Edge daemon configuration.

Get the IP address first. Enter `ifconfig` in your command line and copy the IP address of the **docker0** interface.

Edit the IoT Edge daemon configuration file:

```cmd/sh
sudo nano /etc/iotedge/config.yaml
```

Update the **connect** section of the configuration with your IP address. For example:
```yaml
connect:
  management_uri: "http://172.17.0.1:15580"
  workload_uri: "http://172.17.0.1:15581"
```

Enter the same addresses in the **listen** section of the configuration. For example:

```yaml
listen:
  management_uri: "http://172.17.0.1:15580"
  workload_uri: "http://172.17.0.1:15581"
```

Create an environment variable IOTEDGE_HOST with the management_uri address (To set it permanently, add it to `/etc/environment`).For example:

```cmd/sh
export IOTEDGE_HOST="http://172.17.0.1:15580"
```


## Create the Azure Machine Learning service container

In this section, you convert trained machine learning model files and into an Azure Machine Learning service container. All the components required for the Docker image are in the [AI Toolkit for Azure IoT Edge Git repo](https://github.com/Azure/ai-toolkit-iot-edge/tree/master/IoT%20Edge%20anomaly%20detection%20tutorial). Follow these steps to upload that repository into Microsoft Azure Notebooks to create the container and push it to Azure Container Registry.


1. Create an Azure Machine Learning service workspace. Follow the instructions in [Use the Azure portal to get started with Azure Machine Learning](../machine-learning/service/quickstart-get-started.md) then return to this article.
2. In the Getting Started project that you created in the Azure Machine Learning article, navigate to the **config.json** file. 
3. Copy the values for **subscription_id**, **resource_group**, and **workspace_name** from the config file and save them somewhere locally. You'll use these values in the following steps to configure the IoT Edge project for this article. 
4. On the **My Projects** page of Microsoft Azure Notebooks, select **Upload GitHub Repo**.
5. Provide the following Github repository name: `Azure/ai-toolkit-iot-edge`. Uncheck the **Public** box if you want to keep your project private. Select **Import**. 
6. Once the import is finished, navigate into the new **ai-toolkit-iot-edge** project and open the **IoT Edge anomaly detection tutorial** folder. 
7. Open the **config.json** file. 
8. Edit the file to include the values that you copied from your Getting Started project. Save your changes and close the file.
9. Verify that your project is running. If not, select **Run on Free Compute**.
10. Open the **registermodel-createimage-deployservice.ipynb** file.
11. Run all the cells in the notebook to register the premade model in the project, create a Docker image, and deploy the image as a web service.

Once you complete all the steps in the notebook, you should have a Docker container image built with the anomaly detection model. In the next section, you'll see where that container image is stored in your Azure account. 

### View the container repository

Check that your container image was successfully created and stored in the Azure Container registry that is associated with your machine learning environment.

1. On the [Azure portal](https://portal.azure.com), go to **All Services** and Select **Container registries**.
2. Look for a new registry that was created in the resource group and subscription that you used to configure the Azure Notebooks project. Its name will start with the name of your Azure Machine Learning workspace.
3. Open the registry to see its details.
4. Select **Access keys**
5. Copy the **Login server**, **Username**, and **Password**.  You need these to access the registry from your IoT Edge devices.
6. Select **Repositories**. You should see a repository called **mlimage1** that was created by the notebook you ran in the previous section. 
7. Select **mlimage1**. You should see that the repository has one tag: **1**. 
8. Now that you know the registry name, repository name, and tag, you know the full image path of the container. Take note of this image path for the next section. It should look like **\<registry_name\>.azurecr.io/mlimage1:1**.

With your Machine Learning service model built as a container image and stored in your container registry, you're ready to deploy it to an IoT Edge device. 

## Deploy to your device

1. On the [Azure portal](https://portal.azure.com), navigate to your IoT hub.

2. Go to **IoT Edge** and select your IoT Edge device.

3. Select **Set modules**.

4. In the **Registry Settings** section, add the credentials that you copied from your Azure container registry.

   ![Add registry credentials to manifest](./media/tutorial-deploy-machine-learning/registry-settings.png)

5. If you've previously deployed the tempSensor module to your IoT Edge device, it may autopopulate. If it's not already in your list of modules, add it.

    1. Click **Add** and select **IoT Edge Module**.
    2. In the **Name** field, enter `tempSensor`.
    3. In the **Image URI** field, enter `mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0`.
    4. Select **Save**.

6. Add the machine learning module that you created.

    1. Click **Add** and select **IoT Edge Module**.
    2. In the **Name** field, enter `machinelearningmodule`.
    3. In the **Image URI** field, enter the image path for your module, like `<registry_name>.azurecr.io/mlimage1:1`.
    1. Select **Save**.

7. Select **Next**.

8. In the **Specify Routes** step, copy the JSON below into the text box. The first route transports messages from the temperature sensor to the machine learning module via the "amlInput" endpoint, which is the endpoint that all Azure Machine Learning modules use. The second route transports messages from the machine learning module to IoT Hub. In this route, ''amlOutput'' is the endpoint that all Azure Machine Learning modules use to output data, and ''$upstream'' denotes IoT Hub.

    ```json
    {
        "routes": {
            "sensorToMachineLearning":"FROM /messages/modules/tempSensor/outputs/temperatureOutput INTO BrokeredEndpoint(\"/modules/machinelearningmodule/inputs/amlInput\")",
            "machineLearningToIoTHub": "FROM /messages/modules/machinelearningmodule/outputs/amlOutput INTO $upstream"
        }
    }
    ```

9. Select **Next**.

10. In the **Review Deployment** step, select **Submit**.

11. Return to the device details page and select **Refresh**.  You should see the new **machinelearningmodule** running along with the **tempSensor** module and the IoT Edge runtime modules.

## View generated data

You can view messages being generated by each IoT Edge module, and you can view messages that are delivered to your IoT hub.

### View data on your IoT Edge device

On your IoT Edge device, you can view the messages being sent from every individual module.

If you perform these commands on a Linux device, you may need to use `sudo` for elevated permissions.

1. View all modules on your IoT Edge device.

   ```cmd/sh
   iotedge list
   ```

2. View the messages being sent from a specific device. Use the module name from the output of the previous command.

   ```cmd/sh
   iotedge logs <module_name> -f
   ```

### View data arriving at your IoT hub

You can view the device-to-cloud messages that your IoT hub receives by using the [Azure IoT Hub Toolkit extension for Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-toolkit) (formerly Azure IoT Toolkit extension).

The following steps show you how to set up Visual Studio Code to monitor device-to-cloud messages that arrive at your IoT hub.

1. In Visual Studio Code, select **IoT Hub Devices**.

2. Select **...** then select **Set IoT Hub Connection String** from the menu.

   ![Set IoT Hub Connection String](./media/tutorial-deploy-machine-learning/set-connection.png)

3. In the text box that opens at the top of the page, enter the iothubowner connection string for your IoT Hub. Your IoT Edge device should appear in the IoT Hub Devices list.

4. Select **...** again then select **Start monitoring D2C message**.

5. Observe the messages coming from tempSensor every five seconds. The message body contains a property called **anomaly** which the machinelearningmodule provides with a true or false value. The **AzureMLResponse** property contains the value "OK" if the model ran successfully.

   ![Azure Machine Learning service response in message body](./media/tutorial-deploy-machine-learning/ml-output.png)

## Clean up resources

If you plan to continue to the next recommended article, you can keep the resources and configurations that you created and reuse them. You can also keep using the same IoT Edge device as a test device.

Otherwise, you can delete the local configurations and the Azure resources that you created in this article to avoid charges.

[!INCLUDE [iot-edge-clean-up-cloud-resources](../../includes/iot-edge-clean-up-cloud-resources.md)]

[!INCLUDE [iot-edge-clean-up-local-resources](../../includes/iot-edge-clean-up-local-resources.md)]


## Next steps

In this tutorial, you deployed an IoT Edge module powered by Azure Machine Learning. You can continue on to any of the other tutorials to learn about other ways that Azure IoT Edge can help you turn data into business insights at the edge.

> [!div class="nextstepaction"]
> [Classify images with Custom Vision service](tutorial-deploy-custom-vision.md)

