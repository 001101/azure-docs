---
# Mandatory fields. See more on aka.ms/skyeye/meta.
title: Deploy Azure Function with Azure IoT Edge | Microsoft Docs 
description: Deploy Azure Function as a module to an edge device
services: iot-edge
keywords: 
author: JimacoMS2
manager: timlt

ms.author: v-jamebr
ms.date: 10/05/2017
ms.topic: article
ms.service: iot-edge

# Optional fields. Don't forget to remove # if you need a field.
# ms.custom: can-be-multiple-comma-separated
# ms.devlang:devlang-from-white-list
# ms.suite: 
# ms.tgt_pltfrm:
# ms.reviewer:
---

# Deploy Azure Function as an IoT Hub module 
You can use Azure Functions to deploy code that implements your business logic directly to your IoT Edge devices. This tutorial walks you through creating and deploying an Azure Function that filters sensor data on the simulated IoT Edge device that you created in the [Azure Install IoT Edge tutorial](./tutorial-install-iot-edge.md). You learn how to:    

> [!div class="checklist"]
> * Use Visual Studio Code to create an azure function
> * Use VS Code and Docker to create a docker image and publish it to your registry 
> * Deploy the module to your IoT Edge device
> * View generated data


The Azure Function that you create in this tutorial filters the temparture data generated by your device and only sends messages upstream when the temprature is above a specified threshold. 

## Prerequisites

* The Azure IoT Edge device that you created in the [Azure Install IoT Edge tutorial](./tutorial-install-iot-edge.md).
* The IoT Hub connection string for the IoT hub that your IoT Edge device connects to.  
* [Visual Studio Code](https://code.visualstudio.com/). 
* The following Visual Studio Code extensions: 
  * [C# for Visual Studio Code (powered by OmniSharp) extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode.csharp). (You can install the extension from the extensions panel in Visual Studio Code.)
  * **Azure IoT Edge extension**

    > [!IMPORTANT] The IoT Edge extension is not yet available in Marketplace. Perform the following steps to install it:
    > 1. Install the [Azure IoT Toolkit extension](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-toolkit) from the extensions panel in VS Code.
    > 2. Downlad the **Azure IoT Edge extension** VSIX here: [https://aka.ms/edge-extension](https://aka.ms/edge-extension)
    > 3. Install the extension VSIX by using the **View | Command Palette... | Extensions: Install from VSIX...** menu command, navigating to the downloaded VSIX on your computer and clicking **Open**. (You can also install the extension by clicking **...** in the upper-right corner of the extension panel and selecting **Install from VSIX...**.)
* [Docker](https://docs.docker.com/engine/installation/). The Community Edition (CE) for your platform is sufficient for this tutorial. 
* [.NET Core 2.0 SDK](https://www.microsoft.com/net/core#windowscmd). 
* [Nuget CLI](https://docs.microsoft.com/en-us/nuget/guides/install-nuget#nuget-cli). 

## Bug Bash Configuration steps
For the bug bash perform the following steps to configure VS Code.
1. Use the **View | Integrated Terminal** menu command to open the Visual Studio Code integrated terminal.
1. In integrated terminal, add a Nuget source for the **AzureIotEdgeFunction** template Noget package.  
  - For Nuget V3 
 
    ```cmd/sh
    nuget sources add -name AzureIoTEdgeFunction -source https://www.myget.org/F/dotnet-template-azure-iot-edge-function/api/v3/index.json  
    ``` 

  - For Nuget V2 
    ```cmd/sh     
    nuget sources add -name AzureIoTEdgeFunction -source https://www.myget.org/F/dotnet-template-azure-iot-edge-function/api/v2/index.json 
    ```

2. Install the **AzureIoTEdgeFunction** template in dotnet

    ```cmd/sh
    dotnet new -i Microsoft.Azure.IoT.Edge.Function
    ```

## Create a Docker container registry
For this tutorial, you will need a Docker registry to publish your IoT Edge module to. You can use any Docker-compatible container registry, for example: [Azure Container Registry](https://docs.microsoft.com/en-us/azure/container-registry/) or [Docker Hub](https://docs.docker.com/docker-hub/repos/#viewing-repository-tags). If you already have a Docker-compatible container registry, you can use it; otherwise, you can get a free private Docker repository on Docker Hub when you sign up for a Docker ID. 

1. To sign up for a Docker ID, follow the instructions in [Register for a Docker ID](https://docs.docker.com/docker-id/#register-for-a-docker-id) on the Docker site. 

2. To create a private Docker repository, follow the instructions in [Creating a new repository on Docker Hub](https://docs.docker.com/docker-hub/repos/#creating-a-new-repository-on-docker-hub) on the Docker site.

## Configure the IoT Edge Visual Studio Code extension with your IoT hub connection string 
1. Open Visual Studio Code.
2. Use the **View | Explorer** menu command to open the VS Code explorer. 
3. In the explorer, click **IOT HUB DEVICES** and then click **...**. Click **Set IoT Hub Connection String** and enter the connection string for the IoT hub that your IoT Edge device connects to in the pop-up window.  

## Create a custom IoT Edge function project
The following steps show you how to create a IoT Edge function using Visual Studio Code and the IoT Edge extension.
1. Use the **View | Integrated Terminal** menu command to open the VS Code integrated terminal.
2. In the integrated terminal, enter the following command to create a project for the new module:

    ```cmd/sh
    dotnet new aziotedgefunction -n FilterFunction
    ```
3. Use the  **File | Open Folder** menu command, browse to the **FilterFunction**  folder, and click **Select Folder** to open the project in VS Code.
4. In VS Code explorer, click **run.csx** to open it.
5. Add the following statements:

    ```csharp
    #r "Microsoft.Azure.Devices.Client"
    #r "System.Collection.Generic"
    #r "Newtonsoft.Json"
    ```

5. Add the following using statements:

    ```csharp
    using Microsoft.Azure.Devices.Client;
    using System.Collections.Generic;
    using Newtonsoft.Json;
    ```

1. Add the following classes. These classes define the expected schema for the body of incoming messages.

    ```csharp
    class MessageBody
    {
        public Machine machine {get;set;}
        public Ambient ambient {get; set;}
        public string timeCreated {get; set;}
    }
    class Machine
    {
       public double temperature {get; set;}
       public double pressure {get; set;}         
    }
    class Ambient
    {
       public double temperature {get; set;}
       public int humidity {get; set;}         
    }
    ```

1. Add the following code to the end of the **Run** method. It filters messages based on the temperature value in the body of the message and the temperature threshold value.

    ```csharp
    const int temperatureThreshold = 25;
    // Get message body
    var messageBody = JsonConvert.DeserializeObject<MessageBody>(messageString);

    if (messageBody != null && messageBody.machine.temperature > temperatureThreshold)
    {
        log.Info($"Machine temperature {messageBody.machine.temperature} " +
          $"exceeds threshold {temperatureThreshold}");
        var filteredMessage = new Message(messageBytes);
        foreach (KeyValuePair<string, string> prop in messageReceived.Properties)
        {
            filteredMessage.Properties.Add(prop.Key, prop.Value);
        }

        filteredMessage.Properties.Add("MessageType", "Alert");
      
        await output.AddAsync(filteredMessage);
    }
    ```

11. Save the file.

## Create a Docker image and publish it to your registry

1. Build the docker image.
  1. In VS Code explorer, click on the **Docker** folder to open it, then right-click the **Dockerfile** and click **Build IoT Edge module Docker image**. 
  2. In the **Select Folder** box, click **Select Folder as EXE_DIR**. (Do not enter a value.)
    a. In the pop-up text box at the top of the VS Code window, enter the image URL; for example, `<docker registry address>/filterfunction:latest`.
 
4. Sign in to Docker. In integrated terminal, enter the following command and enter your credentials when prompted:

    ```csh/sh
    docker login
    ```
    > [!NOTE] By default, the **docker login** command connects to your private Docker Hub repository. If you are working with a different container registry, for example, Azure container registry, you may need to specify the login server for that registry as the **\[SERVER\]** parameter to the **docker login** command. For details about **docker login**, enter the following command:
    >
    > ```csh/sh
    > docker help login
    > ```
3. Push the image to your Docker repository. Use the **View | Command Palette ... | Edge: Push IoT Edge module Docker image** menu command and enter the image URL in the pop-up text box at the top of the VS Code window. This should be the same image URL you used in step 1.a.; for example, `<docker registry address>/filterfunction:latest`.

## Run the solution

1. On the [Azure portal](https://portal.azure.com), navigate to the device detail blade, click **deploy modules**. 
2. Select **custom module**, copy snippet

    ```json
    {
       "filtermodule":{
          "version":"1.0",
          "type":"docker",
          "status":"running",
          "restartPolicy":"always",
          "settings":{
             "image":"{your registry}/filterfunction:latest",
             "createOptions":""
          }
       }
    }
    ``` 
4. Click **start**. 
5. In the device detail blade, click **refresh** to see things working. 

## View generated data

 In VS Code, use the **View | Command Palette... | IoT: Start Monitoring D2C Messages** menu command to monitor data arriving in the IoT Hub. 

## Next steps

In this tutorial, you created an Azure Function that contains code to filter raw data generated by your IoT Edge device. You can continue on to either of the following tutorials to learn about other ways that Azure IoT Edge can help you turn data into business insights at the edge.

> [!div class="nextstepaction"]
> [Create a custom module](tutorial-create-custom-module.md)
> [Deploy Azure Stream Analytics as a module](tutorial-deploy-stream-analytics.md)
- 