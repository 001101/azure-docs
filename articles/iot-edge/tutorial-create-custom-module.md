---
# Mandatory fields. See more on aka.ms/skyeye/meta.
title: Deploy a custom module for Azure IoT Edge | Microsoft Docs 
description: Create a custom module and deploy it to an edge device
services: iot-edge
keywords: 
author: JimacoMS2
manager: timlt

ms.author: v-jamebr
ms.date: 10/18/2017
ms.topic: article
ms.service: iot-edge

# Optional fields. Don't forget to remove # if you need a field.
# ms.custom: can-be-multiple-comma-separated
# ms.devlang:devlang-from-white-list
# ms.suite: 
# ms.tgt_pltfrm:
# ms.reviewer:
---

# Deploy a custom IoT Edge module to your simulated device

You can use IoT Edge modules to deploy code that implements your business logic directly to your IoT Edge devices. This tutorial walks you through creating and deploying a custom module that filters sensor data on the simulated IoT Edge device that you created in the [Azure Install IoT Edge tutorial](./tutorial-install-iot-edge.md). You learn how to:    

> [!div class="checklist"]
> * Use Visual Studio Code to create a custom module
> * Use VS Code and Docker to create a docker image and publish it to your registry 
> * Deploy the module to your IoT Edge device
> * View generated data


The custom module that you create in this tutorial filters the temperature data generated by your device and only sends messages upstream when the temperature is above a specified threshold. 

## Prerequisites

* The Azure IoT Edge device that you created in the [Azure Install IoT Edge tutorial](./tutorial-install-iot-edge.md).
* The IoT Hub connection string for the IoT hub that your IoT Edge device connects to.  
* [Visual Studio Code](https://code.visualstudio.com/). 
* The following Visual Studio Code extensions: 
  * [C# for Visual Studio Code (powered by OmniSharp) extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode.csharp). (You can install the extension from the extensions panel in Visual Studio Code.)
  * **Azure IoT Edge extension**

    > [!IMPORTANT]
    > The IoT Edge extension is not yet available in the Marketplace. Perform the following steps to install it and its dependencies:
    > 1. Install the [Azure IoT Toolkit extension](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-toolkit) from the extensions panel in VS Code.
    > 2. Download the **Azure IoT Edge extension** VSIX here: [https://aka.ms/edge-extension](https://aka.ms/edge-extension). **Note**: If you use Microsoft Edge or Internet Explorer, the browser downloads the file with a ".zip" file extension. After the file downloads, you need to change the file extension back to ".vsix". 
    > 3. Install the extension VSIX by using the **View | Command Palette... | Extensions: Install from VSIX...** menu command, navigating to the downloaded VSIX on your computer and clicking **Open**. (You can also install the extension by clicking **...** in the upper-right corner of the extension panel and selecting **Install from VSIX...**.)
* [Docker](https://docs.docker.com/engine/installation/). The Community Edition (CE) for your platform is sufficient for this tutorial. 
* [.NET Core 2.0 SDK](https://www.microsoft.com/net/core#windowscmd). 

## Bug bash configuration steps
The steps in this section are only required until Azure IoT Edge goes public. They walk you through setting up VS Code with dependencies that will not be public until we release Azure IoT Edge. 
 
1. Install version 3 or later of the [NuGet CLI](https://docs.microsoft.com/en-us/nuget/guides/install-nuget#nuget-cli). The module code depends on a couple of NuGet packages that won't be made public until we release Azure IoT Edge. For the time being, we have placed them on `myget`. You need the NuGet CLI to reference these packages. 
2. Open Visual Studio Code. 
3. Use the **View | Integrated Terminal** menu command to open the VS Code integrated terminal.
4. In integrated terminal, add a NuGet source for the **AzureIotEdgeModule** template NuGet package.  

    ```cmd/sh
    nuget sources add -name AzureIoTEdgeModule -source https://www.myget.org/F/dotnet-template-azure-iot-edge-module/api/v3/index.json 
    ``` 

3. The preview version of the **Microsoft.Azure.Devices.Client** package used in this tutorial is not yet available in the public gallery. To ensure that your IoT Edge module will build correctly, add a NuGet source that contains the correct package version. 

    ```cmd/sh
    nuget sources Add -Name "Edge Private Preview" -source https://www.myget.org/F/aziot-device-sdk/api/v3/index.json
    ```

## Create a Docker container registry
For this tutorial, you need a Docker registry to publish your IoT Edge module to. You can use any Docker-compatible container registry, for example: [Azure Container Registry](https://docs.microsoft.com/en-us/azure/container-registry/) or [Docker Hub](https://docs.docker.com/docker-hub/repos/#viewing-repository-tags). If you already have a Docker-compatible container registry, you can use it; otherwise, you can get a free private Docker repository on Docker Hub when you sign up for a Docker ID. 

1. To sign up for a Docker ID, follow the instructions in [Register for a Docker ID](https://docs.docker.com/docker-id/#register-for-a-docker-id) on the Docker site. 

2. To create a private Docker repository, follow the instructions in [Creating a new repository on Docker Hub](https://docs.docker.com/docker-hub/repos/#creating-a-new-repository-on-docker-hub) on the Docker site.

## Configure the Azure IoT Toolkit extension with your IoT hub connection string 
1. Open Visual Studio Code.
2. Use the **View | Explorer** menu command to open the VS Code explorer. 
3. In the explorer, click **IOT HUB DEVICES** and then click **...**. Click **Set IoT Hub Connection String** and enter the connection string for the IoT hub that your IoT Edge device connects to in the pop-up window.  

## Create a custom IoT Edge module project
The following steps show you how to create an IoT Edge module using Visual Studio Code and the IoT Edge extension.
1. Use the **View | Integrated Terminal** menu command to open the VS Code integrated terminal.
1. In the integrated terminal, enter the following command to install the **AzureIoTEdgeModule** template in dotnet:

    ```cmd/sh
    dotnet new -i Microsoft.Azure.IoT.Edge.Module
    ```

2. In the integrated terminal, enter the following command to create a project for the new module:

    ```cmd/sh
    dotnet new aziotedgemodule -n FilterModule
    ```

    >[!NOTE]
    > This command creates the project folder, **FilterModule**, in the current working folder. If you want to create it in another location, change directories before running the command.
 
3. Use the  **File | Open Folder** menu command, browse to the **FilterModule**  folder, and click **Select Folder** to open the project in VS Code.
4. In VS Code explorer, click **Program.cs** to open it.
5. Add the following field to the **Program** class.

    ```csharp
    static int temperatureThreshold { get; set; } = 25;
    ```

1. Add the following classes to the **Program** class. These classes define the expected schema for the body of incoming messages.

    ```csharp
    class MessageBody
    {
        public Machine machine {get;set;}
        public Ambient ambient {get; set;}
        public string timeCreated {get; set;}
    }
    class Machine
    {
       public double temperature {get; set;}
       public double pressure {get; set;}         
    }
    class Ambient
    {
       public double temperature {get; set;}
       public int humidity {get; set;}         
    }
    ```

7. In the **InitEdgeModule** method, replace the code in the **try** block with the following code. This code creates and configures a **DeviceClient** object, which allows the module to  connect to the local Azure IoT Edge runtime to send and receive messages. This is similar to the way code in a device uses a **DeviceClient** to connect to a remote IoT Hub, except that the endpoint and credential information used in the connection string are specific to the Edge hub. The connection string parameter used in the **InitEdgeModule** method is supplied to the module by Azure IoT Edge in an environment variable - **EdgeHubConnectionString**. After creating the **DeviceClient**, the code registers a callback for desired properties updates on the module twin and registers the **FilterHandler** method as the handler for messages from the Edge Hub via the "input1" endpoint.

    ```csharp
    // Open a connection to the Edge runtime using MQTT transport and 
    // the connection string provded as an environment variable
    ITransportSettings[] settings =
    {
        new MqttTransportSettings(TransportType.Mqtt_Tcp_Only)
        { RemoteCertificateValidationCallback = (sender, certificate, chain, sslPolicyErrors) => true }
    };

    DeviceClient IoTHubModuleClient = DeviceClient.CreateFromConnectionString(Environment.GetEnvironmentVariable("EdgeHubConnectionString"), settings);
    await IoTHubModuleClient.OpenAsync();
    Console.WriteLine("IoT Hub module client initialized.");

    // Attach callback for Twin desired properties updates
    await IoTHubModuleClient.SetDesiredPropertyUpdateCallbackAsync (onDesiredPropertiesUpdate, null);

    // Register callback to be called when a message is received by the module
    await IoTHubModuleClient.SetInputMessageHandlerAsync("input1", FilterMessages, IoTHubModuleClient);

    ```

1. Add the following method to the **Program** class to update the **temperatureThreshold** field based on the desired properties sent by the back-end service via the module twin. All modules have their own module twin. A module twin lets a back-end service configure the code running inside a module, just like a device twin lets a back-end service configure code running on a device.

    ```csharp
    static async Task onDesiredPropertiesUpdate(TwinCollection desiredProperties, object userContext)
    {
        try
        {
            await Task.Run( () => {
                Console.WriteLine("Desired property change:");
                Console.WriteLine(JsonConvert.SerializeObject(desiredProperties));

                if (desiredProperties["TemperatureThreshold"].exists())
                    temperatureThreshold = desiredProperties["TemperatureThreshold"];
            });
        }
        catch (AggregateException ex)
        {
            foreach (Exception exception in ex.InnerExceptions)
            {
                Console.WriteLine();
                Console.WriteLine("Error when receiving desired property: {0}", exception);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine();
            Console.WriteLine("Error when receiving desired property: {0}", ex.Message);
        }
    }
    ```

1. Replace the **PipeMessage** method with the following method. This method is called whenever the module is sent a message from the Edge Hub. It filters messages based on the temperature value in the body of the message, and the temperature threshold set via the module twin.

    ```csharp
    static async Task<MessageResponse> FilterMessages(Message message, object userContext)
    {
        int counterValue = Interlocked.Increment(ref counter);

        try {
            DeviceClient deviceClient = (DeviceClient)userContext;

            byte[] messageBytes = message.GetBytes();
            string messageString = Encoding.UTF8.GetString(messageBytes);
            Console.WriteLine($"Received message {counterValue}: [{messageString}]");

            // Get message body
            var messageBody = JsonConvert.DeserializeObject<MessageBody>(messageString);

            if (messageBody != null && messageBody.machine.temperature > temperatureThreshold)
            {
                Console.WriteLine($"Machine temperature {messageBody.machine.temperature} " +
                    $"exceeds threshold {temperatureThreshold}");
                var filteredMessage = new Message(messageBytes);
                foreach (KeyValuePair<string, string> prop in message.Properties)
                {
                    filteredMessage.Properties.Add(prop.Key, prop.Value);
                }

                filteredMessage.Properties.Add("MessageType", "Alert");
                await deviceClient.SendEventAsync("output1", filteredMessage);
            }

            // We need to indicate that we have completed the message treatment
            return MessageResponse.Completed;
        }
        catch (AggregateException ex)
        {
            foreach (Exception exception in ex.InnerExceptions)
            {
                Console.WriteLine();
                Console.WriteLine("Error in sample: {0}", exception);
            }
            // We need to indicate that we have not completed the message treatment
            DeviceClient deviceClient = (DeviceClient)userContext;
            return MessageResponse.Abandoned;
        }
        catch (Exception ex)
        {
            Console.WriteLine();
            Console.WriteLine("Error in sample: {0}", ex.Message);
            // We need to indicate that we have not completed the message treatment
            DeviceClient deviceClient = (DeviceClient)userContext;
            return MessageResponse.Abandoned;
        }
    }
    ```

11. Build the project. Use the **View | Explorer** menu command to open the VS Code explorer. In the explorer, right-click the **SampleModule.csproj** file and click **Build IoT Edge module**.

## Create a Docker image and publish it to your registry

1. Build the Docker image.
   1. In VS Code explorer, click on the **Docker** folder to open it, then right-click the **Dockerfile** and click **Build IoT Edge module Docker image**. 
   2. In the **Select Folder** box, either browse to or enter `./bin/Debug/netcoreapp2.0/publish`. Click **Select Folder as EXE_DIR**.
   3. In the pop-up text box at the top of the VS Code window, enter the image URL; for example, `<docker registry address>/filtermodule:latest`.
 
4. Sign in to Docker. In integrated terminal, enter the following command and enter your credentials when prompted:

    ```csh/sh
    docker login
    ```
    > [!NOTE] By default, the **docker login** command connects to your private Docker Hub repository. If you are working with a different container registry, for example, Azure container registry, you may need to specify the login server for that registry as the **\[SERVER\]** parameter to the **docker login** command. For details about **docker login**, enter the following command:
    >
    > ```csh/sh
    > docker help login
    > ```
3. Push the image to your Docker repository. Use the **View | Command Palette ... | Edge: Push IoT Edge module Docker image** menu command and enter the image URL in the pop-up text box at the top of the VS Code window. Use the same image URL you used in step 1.a.; for example, `<docker registry address>/filtermodule:latest`.

## Add registry credentials to Edge runtime on your Edge device
Add the credentials for your registry to the Edge runtime on the machine where you are running your Edge device. This gives the runtime access to pull the container. Run the following command on the machine where you are running your Edge device:

```cmd/sh
iotedgectl login --address --username --password 
```

> [!NOTE]
> The preceding command gives the Python 2.7 command for Windows. If you're running your Edge device on Linux, add `sudo` in front of the command.

## Run the solution

1. In the **Azure portal**, [https://df.onecloud.azure-test.net/](https://df.onecloud.azure-test.net/), navigate to your IoT hub.
2. Go to **IoT Edge Explorer** and select your IoT Edge device.
3. Select **Deploy modules**. 
4. Select **Add custom IoT Edge module**.
5. In the **Name** field, enter `tempSensor`.
6. In the **Image** field, enter `edgepreview.azurecr.io/azureiotedge/simulated-temperature-sensor:1.0-preview`.
7. In the **OS** field, select **linux**.
8. Leave the other settings unchanged and select **Save**.
9. From the **Add Modules** step, select **Add custom IoT Edge module** again.
10. In the **Name** field, enter `filtermodule`.
11. In the **Image** field, enter your image address; for example `{your registry}/filtermodule:latest`.
12. In the **OS** field, select **linux**.
13. In the **Architecture** field, select **x64**.
14. Check the **Edit module twin** box.
15. Replace the JSON in the text box with the following JSON: 

    ```json
    {
       "properties.desired":{
          "TemperatureThreshold":25
       }
    }
    ```
 
11. Click **Save**.
12. Back in the **Add Modules** step, click **Next**.
13. In the **Specify Routes** step, copy the JSON below into the text box. Modules publish all messages to the Edge runtime. Declarative rules in the runtime define where those messages flow. In this tutorial you need two routes. The first route transports messages from the temperature sensor to the filter module via the "input1" endpoint, which is the endpoint that you configured with the  **FilterMessages** handler. The second route transports messages from the filter module to IoT Hub. In this route, `upstream` is a special destination that tells Edge Hub to send messages to IoT Hub. 

    ```json
    {
       "routes":{
          "sensorToFilter":"FROM /messages/modules/tempSensor/outputs/temperatureOutput INTO BrokeredEndpoint(\"/modules/filtermodule/inputs/input1\")",
          "filterToIoTHub":"FROM /messages/modules/filtermodule/outputs/output1 INTO $upstream"
       }
    }
    ```

4. Click **Next**.
5. In the **Review Template** step, click **Submit**. 
6. Return to the device details page and click **Refresh**. You should see the new **filtermodule** running along with the **tempSensor** module and the **IoT Edge runtime**. 

## View generated data

In VS Code, use the **View | Command Palette... | IoT: Start Monitoring D2C Messages** menu command to monitor data arriving in the IoT Hub. 

## Next steps

In this tutorial, you created a custom module that contains code to filter raw data generated by your IoT Edge device. You can continue on to either of the following tutorials to learn about other ways that Azure IoT Edge can help you turn data into business insights at the edge.

> [!div class="nextstepaction"]
> [Deploy Azure Function as a module](tutorial-deploy-function.md)
> [Deploy Azure Stream Analytics as a module](tutorial-deploy-stream-analytics.md)
