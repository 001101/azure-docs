---
# Mandatory fields. See more on aka.ms/skyeye/meta.
title: Troubleshoot device connectivity to IoT Hub tutorial
description: Use IoT Hub tools to troubleshoot device connectivity issues to your IoT hub.
services: iot-hub
# keywords: Donâ€™t add or edit keywords without consulting your SEO champ.
author: dominicbetts
ms.author: dobett
ms.date: 04/10/2018
ms.topic: tutorial
# Use only one of the following. Use ms.service for services, ms.prod for on-prem. Remove the # before the relevant field.
ms.service: iot-hub
# product-name-from-white-list

# Optional fields. Don't forget to remove # if you need a field.
# ms.custom: can-be-multiple-comma-separated
# ms.devlang:devlang-from-white-list
# ms.suite: 
# ms.tgt_pltfrm:
# ms.reviewer:
# manager: MSFT-alias-manager-or-PM-counterpart

# As a developer or IT Pro, I want to know what tools I can use to troubleshoot connectivity issues between my IoT devices and my IoT hub.
---

# Troubleshoot device connectivity

In this tutorial, you use a selection of Azure IoT Hub portal tools and Azure CLI utilities to troubleshoot device connectivity issues. This tutorial also uses a simple device simulator that you run on your desktop machine.

If you don't have an Azure subscription, [create a free account](https://azure.microsoft.com/free/) before you begin.

In this tutorial, you learn how to:
> [!div class="checklist"]
> * Check your device keys
> * Check device-to-cloud connectivity
> * Check cloud-to-device connectivity
> * Check device twin synchronization

## Prerequisites

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

The device simulator application you run in this tutorial is written using Node.js. You need Node.js v4.x.x or later on your development machine.

You can download Node.js for multiple platforms from [nodejs.org](https://nodejs.org).

You can verify the current version of Node.js on your development machine using the following command:

```cmd/sh
node --version
```

Download the sample device simulator Node.js project from https://github.com/Azure-Samples/iot-hub-tutorials-node/archive/master.zip and extract the ZIP archive.

## Create an IoT hub

If you created a free or standard tier IoT hub in a previous quickstart or tutorial, you can skip this step.

[!INCLUDE [iot-hub-quickstarts-create-hub](../../includes/iot-hub-quickstarts-create-hub.md)]

## Device keys

A device must authenticate with your hub before it can exchange any data with the hub. You can use the **IoT Devices** tool in the **Device Management** section of the portal to manage your devices and check the authentication keys you are using. In this section of the tutorial, you add a new test device, retrieve its key, and check that the test device can connect to the hub. Later you reset the authentication key to observe what happens when a device tries to use an outdated key. This section of the tutorial uses the Azure portal to create, manage and monitor a device, and the sample Node.js device simulator.

Sign in to the portal and navigate to your IoT hub. Then navigate to the **IoT Devices** tool:

![IoT Devices tool](#)

To register a new device, click **+ Add**, set **Device ID** to **MyTestDevice**, and click **Save**:

![Add new device](#)

To retrieve the connection string for **MyTestDevice**, click on it in the list of devices and then copy the **Connection string-primary key** value. The connection string includes the *shared access key* for the device.

![Retrieve device connection string](#)

To simulate **MyTestDevice** sending telemetry to your IoT hub, run the Node.js simulated device application you downloaded previously.

In a terminal window on your development machine, navigate to the root folder of the sample Node.js project you downloaded. Then navigate to the **simulated-device** folder.

Open the **SimulatedDevice-1.js** file in a text editor of your choice. Replace the value of the `connectionString` variable with the device connection string you made a note of previously. Then save your changes to **SimulatedDevice-1.js** file.

In the terminal window, run the following commands to install the required libraries and run the simulated device application:

```cmd/sh
npm install
node SimulatedDevice-1.js
```

The terminal window displays information as it tries to connect to your hub:

![Simulated device connecting](#)

You have now successfully authenticated from a device using a device key generated by your IoT hub.

### Reset keys

In this section, you reset the device key and observe the error when the simulated device tries to connect.

To reset the primary device key for **MyTestDevice** run the following commands:

```azurecli-interactive
# Install the IoT Extension for Azure CLI 2.0
#  if it's not already installed
az extension add --name azure-cli-iot-ext

# Generate a new Base64 encoded key using the current date
read key < <(date +%s | sha256sum | base64 | head -c 32)

# Reset the primary device key for MyTestDevice
az iot hub device-identity update --device-id MyTestDevice --set authentication.symmetricKey.primaryKey=$key --hub-name {YourIoTHubName}
```

In the terminal window on your development machine, run the simulated device application again:

```cmd/sh
npm install
node SimulatedDevice-1.js
```

This time you see an authentication error when the application tries to connect:

![Connection error](#)

### Generate shared access signature (SAS) token

If your device uses one of the IoT Hub device SDKs the SDK generates the SAS token used to authenticate with the hub from the name of your hub, the name of your device, and the device key. In some scenarios, such as in a cloud protocol gateway or as part of a custom authentication scheme, you may need to generate the SAS token yourself. To troubleshoot issues with your SAS generation code, it's useful to have a way of generating a known-good SAS token to use during testing.

<!-- Not working at the moment, created issue: https://github.com/Azure/azure-iot-cli-extension/issues/22 -->

### Protocols

A device can use any of the following protocols to connect to your IoT hub:

| Protocol | Outbound port |
| --- | --- |
| MQTT |8883 |
| MQTT over WebSockets |443 |
| AMQP |5671 |
| AMQP over WebSockets |443 |
| HTTPS |443 |

If the outbound port is blocked by a firewall, the device cannot connect:

![Port blocked](#)

## Device-to-cloud connectivity

After a device connects, it typically tries to send telemetry to your IoT hub. This section shows you how you can verify that the telemetry sent by the device reaches your hub.

First, retrieve the current connection string for your simulated device using the following command:

```azurecli-interactive
az iot hub device-identity show-connection-string --device-id MyTestDevice --output table --hub-name {YourIoTHubName}
```

To run a simulated device that sends messages, navigate to the **simulated-device** folder in the code you downloaded.

Open the **SimulatedDevice-3.js** file in a text editor of your choice. Replace the value of the `connectionString` variable with the device connection string you made a note of previously. Then save your changes to **SimulatedDevice-3.js** file.

In the terminal window, run the following commands to install the required libraries and run the simulated device application:

```cmd/sh
npm install
node SimulatedDevice-3.js
```

The terminal window displays information as it tries to connect to your hub:

![Simulated device sending mesages](#)

You can use **Metrics (preview)** in the portal to verify that the telemetry messages are reaching your IoT hub:

![Navigate to IoT Hub metrics](#)

Set the time range to **Last 30 minutes**, select your IoT hub in the **Resource** drop-down, and select **Telemetry messages sent** as the metric. The chart shows the aggregate count of messages sent by the simulated device:

![Show IoT Hub metrics](#)

It takes a few minutes for the metrics to become available after you start the simulated device. You can also click **Refresh** on the chart to update the display.

## Cloud-to-device connectivity

This section shows how you can make a test direct method call to a device to check cloud-to-device connectivity. You run a simulated device on your development machine to listen for direct method calls from your hub.

In a terminal window, use the following command to run the simulated device application. You updated the connection string in the sample code in the previous section of this tutorial:

```cmd/sh
node SimulatedDevice-3.js
```

Use the CLI to invoke a direct method on the device:

```azurecli-interactive
az iot hub invoke-device-method --device-id MyTestDevice --method-name TestMethod --timeout 10 --method-payload '{"key":"value"}'  -hub-name {YourIoTHubName}
```

When the simulated device successfully receives the direct method call, it sends an acknowledgement back to the hub.

## Twin synchronization

Devices use twins to synchronize state between the device and the hub. In this section you use the CLI to to send desired properties to a device and read the reported properties sent by the device.

The simulated device you use in this section sends reported properties to the hub whenever it starts, and prints desired properties to the console whenever it receives them.

In a terminal window, use the following command to run the simulated device application. You updated the connection string in the sample code in the previous section of this tutorial:

```cmd/sh
node SimulatedDevice-3.js
```

To verify that the hub received the reported properties from the device. Use the following CLI command:

```azurecli-interactive
az iot hub device-twin show --device-id MyTestDevice --hub-name {YourIoTHubName}
```

In the output from the command, you can see the **devicelaststarted** property in the reported properties section. This property shows the date and time you last started the simulated device.

To verify that the hub can send desired property values to the device, use the following CLI command:

```azurecli-interactive
az iot hub device-twin update --set properties.desired='{"mydesiredproperty":"propertyvalue"}' --device-id MyTestDevice --hub-name {YourIoTHubName}
```

In addition to receiving desired property changes as they are made, the simulated device automatically checks for desired properties when it starts up.

## Clean up resources

## Next steps

In this tutorial, you learned how to:
> [!div class="checklist"]
> * Check your device keys
> * Check device-to-cloud connectivity
> * Check cloud-to-device connectivity
> * Check device twin synchronization
> * Implement the heartbeat pattern

<!- TODO -->
Advance to the next article to learn more
> [!div class="nextstepaction"]
> [Next steps button](contribute-get-started-mvc.md)
