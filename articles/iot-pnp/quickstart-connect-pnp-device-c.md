---
title: Connect IoT Plug and Play Preview sample device code to IoT Hub  | Microsoft Docs
description: Build and run IoT Plug and Play Preview sample device code on Linux or Windows that connects to an IoT hub. Use the Azure CLI to view the information sent by the device to the hub.
author: ericmitt
ms.author: ericmitt
ms.date: 04/23/2020
ms.topic: quickstart
ms.service: iot-pnp
services: iot-pnp
ms.custom: mvc

# As a device developer, I want to see a working IoT Plug and Play device sample connecting to IoT Hub and sending properties and telemetry, and responding to commands. As a solution developer, I want to use a tool to view the properties, commands, and telemetry an IoT Plug and Play device reports to the IoT hub it connects to.
---

# Quickstart: Connect a sample IoT Plug and Play Preview device application running on Linux or Windows to IoT Hub (C)

[!INCLUDE [iot-pnp-quickstarts-2-selector.md](../../includes/iot-pnp-quickstarts-2-selector.md)]

This quickstart shows you how to build a sample IoT Plug and Play device application, connect it to your IoT hub, and use the Azure CLI to view the telemetry it sends. The sample application is written in C and is included in the Azure IoT device SDK for C. A solution developer can use the Azure CLI to understand the capabilities of an IoT Plug and Play device without the need to view any device code.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## Prerequisites

You can run this quickstart on Linux or Windows. The shell commands in this quickstart follow the Linux convention for path separators '`/`', if you're following along on Windows be sure to swap these separators for '`\`'.

The prerequisites differ by operating system:

### Linux

This quickstart assumes you're using Ubuntu Linux. The steps in this quickstart were tested using Ubuntu 18.04.

To complete this quickstart on Linux, install the following software on your local Linux environment:

Install **GCC**, **Git**, **cmake**, and all the required dependencies using the `apt-get` command:

```sh
sudo apt-get update
sudo apt-get install -y git cmake build-essential curl libcurl4-openssl-dev libssl-dev uuid-dev
```

Verify the version of `cmake` is above **2.8.12** and the version of **GCC** is above **4.4.7**.

```sh
cmake --version
gcc --version
```

### Windows

To complete this quickstart on Windows, install the following software on your local Windows environment:

* [Visual Studio (Community, Professional, or Enterprise)](https://visualstudio.microsoft.com/downloads/) - make sure you include the **Desktop Development with C++** workload when you [install](https://docs.microsoft.com/cpp/build/vscpp-step-0-installation?view=vs-2019) Visual Studio.
* [Git](https://git-scm.com/download/).
* [CMake](https://cmake.org/download/).

### Azure IoT explorer

To interact with the sample device in the second part of this quickstart, you use the **Azure IoT explorer** tool. [Download and install the latest release of **Azure IoT explorer**](./howto-install-iot-explorer.md) for your operating system.

[!INCLUDE [iot-pnp-prepare-iot-hub.md](../../includes/iot-pnp-prepare-iot-hub.md)]

Run the following command to get the _IoT hub connection string_ for your hub. Make a note of this connection string, you use it later in this quickstart:

```azurecli-interactive
az iot hub show-connection-string --hub-name <YourIoTHubName> --output table
```

> [!TIP]
> You can also use the Azure IoT Explorer tool to find the IoT hub connection string.

## Download the code

In this quickstart, you prepare a development environment you can use to clone and build the Azure IoT Hub Device C SDK.

Open a command prompt in the directory of your choice. Execute the following command to clone the [Azure IoT C SDKs and Libraries](https://github.com/Azure/azure-iot-sdk-c) GitHub repository into this location:

```cmd\bash
git clone --depth 1 --recurse-submodules -b public-preview-pnp https://github.com/Azure/azure-iot-sdk-c.git
```

You should expect this operation to take several minutes to complete.

## Build the code

You use the device SDK to build the included sample code:

1. Create a _cmake_ subdirectory in the root folder of the device SDK, and navigate to that folder:

    ```cmd\bash
    cd azure-iot-sdk-c
    mkdir cmake
    cd cmake
    ```

1. Run the following commands to build the SDK and samples:

    ```cmd\bash
    cmake ..
    cmake --build .
    ```

> [!TIP]
> On Windows, you can open the solution generated by the `cmake` command in Visual Studio 2019. Open the *ALL_BUILD.vcxproj* project file in the _cmake_ directory and set the **digitalTwin_client** project as the startup project in the solution. You can now build the sample in Visual Studio and run it in debug mode.

## Run the device sample

To run the sample application in the SDK that simulates an IoT Plug and Play device sending telemetry to your IoT hub:

From the _cmake_ folder, navigate to the folder that contains the executable file and run it:

```bash
# Bash
cd digitaltwin_client/samples/digitaltwin_sample_device
./digitaltwin_sample_device "<YourDeviceConnectionString>"
```

```cmd
REM Windows
cd digitaltwin_client\samples\digitaltwin_sample_device
Debug\digitaltwin_sample_device.exe "<YourDeviceConnectionString>"
```

> [!TIP]
> To trace the code execution in Visual Studio on Windows, add a break point to the `main` function in the _digitaltwin_sample_device.c_ file. Add the device connection string as a debugger command argument: **Debug**>**digitaltwin_sample_device Properties**>**Configuration Properties**>**Debugging**>**Command Arguments**.

The device is now ready to receive commands and property updates, and has started sending telemetry data to the hub. Keep the sample running as you complete the next steps.

### Use the Azure IoT explorer to validate the code

After the device client sample starts, use the Azure IoT explorer tool to verify it's working.

[!INCLUDE [iot-pnp-iot-explorer-1.md](../../includes/iot-pnp-iot-explorer-1.md)]

1. To ensure the tool can read the model definition from your device, select **Settings**. In the Settings menu, **On the connected device** may already appear in the Plug and Play configurations; if it does not, select **+ Add module definition source** and then **On the connected device** to add it. To save any changes you made, select **Save and Connect**.

1. Back on the **Devices** overview page, find the device identity you created previously. With the sample device application still running in the command prompt, check that the device **Connection state** in Azure IoT explorer is **Connected**. If the connection state is **Disconnected**, select **Refresh** until it is. Click on the device ID to view more details about the device.

1. Select **IoT Plug and Play components** to view the model information for your device.

[!INCLUDE [iot-pnp-iot-explorer-2.md](../../includes/iot-pnp-iot-explorer-2.md)]

## Review the code

If you want to review the sample code, navigate to the _azure-iot-sdk-c/digitaltwin_client/samples/digitaltwin_sample_environmental_sensor_ folder. Open the environmental sensor model file called _EnvironmentalSensor.interface.json_ in a text editor. This model file defines the properties, telemetry, and commands in the **Environmental Sensor** interface that the device implements.

From this interface, the device developer implements a set of C functions to model the sensor. You can find these implementations in the _digitaltwin_sample_environmental_sensor.c_ file. For example:

```c
DigitalTwinSampleEnvironmentalSensor_CreateInterface
DigitalTwinSampleEnvironmentalSensor_SendTelemetryMessagesAsync
DigitalTwinSampleEnvironmentalSensor_ProcessDiagnosticIfNecessaryAsync
DigitalTwinSampleEnvironmentalSensor_Close
```

The sample device also implements the **SDKInfo** and **DeviceInformation** interfaces. You can find the implementations of the following functions in the _digitaltwin_sample_device_info_ and _digitaltwin_sample_sdk_info_ folders. For example:

```c
DigitalTwinSampleSdkInfo_CreateInterface
DigitalTwinSampleSdkInfo_Close
DigitalTwinSampleDeviceInfo_CreateInterface
DigitalTwinSampleDeviceInfo_Close
```

The sample code uses the high-level functions defined in the following header files:

```c
#include <../digitaltwin_sample_device_info/digitaltwin_sample_device_info.h>
#include <../digitaltwin_sample_environmental_sensor/digitaltwin_sample_environmental_sensor.h>
#include <../digitaltwin_sample_sdk_info/digitaltwin_sample_sdk_info.h>
```

In the _digitaltwin_sample_device.c_ file you can see the definition of the model ID to work with:

```c
#define DIGITALTWIN_SAMPLE_ROOT_INTERFACE_ID "dtmi:YOUR_COMPANY_NAME_HERE:sample_device;1"
```

The `main` function creates a **DeviceClient** instance from your device handle:

```c
DigitalTwin_DeviceClient_CreateFromDeviceHandle(deviceHandle, DIGITALTWIN_SAMPLE_DEVICE_CAPABILITY_MODEL_ID, &dtDeviceClientHandle)
```

Then you can see the calls to the functions that create the **DeviceInfo**, **SDKInfo**, and **EnvironmentalSensor** interfaces:

```c
DigitalTwinSampleDeviceInfo_CreateInterface()
DigitalTwinSampleSdkInfo_CreateInterface()
DigitalTwinSampleEnvironmentalSensor_CreateInterface()
```

After creating the interfaces, the code registers them with your IoT hub:

```c
DigitalTwin_DeviceClient_RegisterInterfaces(...)
```

Now you can use the digital twin to send telemetry:

```c
DigitalTwinSampleEnvironmentalSensor_SendTelemetryMessagesAsync
```

To work with the digital twin, you need to include several headers:

```c
#include <digitaltwin_device_client.h>
#include <digitaltwin_interface_client.h>
```

These headers define functions used with digital twins such as:

```c
DigitalTwin_InterfaceClient_Create
DigitalTwin_InterfaceClient_SetPropertiesUpdatedCallback
DigitalTwin_InterfaceClient_SetCommandsCallback
DigitalTwin_InterfaceClient_SendTelemetryAsync
DigitalTwin_InterfaceClient_ReportPropertyAsync
DigitalTwin_InterfaceClient_UpdateAsyncCommandStatusAsync
DigitalTwin_InterfaceClient_Destroy

DigitalTwin_DeviceClient_CreateFromDeviceHandle
DigitalTwin_DeviceClient_RegisterInterfaces
DigitalTwin_DeviceClient_Destroy

DigitalTwin_Client_GetVersionString
```

You can see these functions in use in the sample. For example, in the *digitaltwin_sample_environmental_sensor.c* file the `DigitalTwinSampleEnvironmentalSensor_SendTelemetryMessagesAsync` function calls `DigitalTwin_InterfaceClient_SendTelemetryAsync`.

[!INCLUDE [iot-pnp-clean-resources.md](../../includes/iot-pnp-clean-resources.md)]

## Next steps

In this quickstart, you've learned how to connect an IoT Plug and Play device to an IoT hub. To learn more about how to build a solution that interacts with your IoT Plug and Play devices, see:

> [!div class="nextstepaction"]
> [How-to: Connect to and interact with a device](howto-develop-solution.md)
