---
title: Mobile Push Notification
description: Quickstart on mobile push notification
author: xixian73
services: azure-communication-services

ms.author: xixian
ms.date: 07/29/2020
ms.topic: quickstart
ms.service: azure-communication-services

---
# Quickstart: Mobile Push Notification

[!INCLUDE [Public Preview Notice](../../includes/public-preview-include.md)]

## Overview
Mobile push notification is the pop up notification you get in the mobile device. For calling, we will be focusing on VoIP (Voice over Internet Protocol) push notifications. We will be offering you the capabilities to register for push notification, to handle push notification, and to unregister push notification.

## Prerequisite

### iOS:
- Step 1: Xcode -> Signing & Capabilities -> Add Capability -> "Push Notifications"
- Step 2: Xcode -> Signing & Capabilities -> Add Capability -> "Background Modes"
- Step 3: "Background Modes" -> Select "Voice over IP" and "Remote notifications"
<!-- Adding picture to show the steps-->

### Android:

This tutorial presumes you have a Firebase account setup with Cloud Messaging (FCM) enabled and your Firebase Cloud Messaging is connected to an Azure Notification Hub (ANH) instance. See [here](https://docs.microsoft.com/en-us/azure/notification-hubs/notification-hubs-android-push-notification-google-fcm-get-started) for more on that.
Additionally, the tutorial assumes you're using Android Studio version 3.6 or higher to build your application.

A set of permissions are required for the Android appplication in order to be able to receive notifications messages from FCM. In your AndroidManifest.xml file, add the following set of permissions right after the *<manifest ...>* or below the *</application>* tag

```XML
    <uses-permission android:name="android.permission.INTERNET"/>
    <uses-permission android:name="android.permission.GET_ACCOUNTS"/>
    <uses-permission android:name="com.google.android.c2dm.permission.RECEIVE" />
```

## Push Notification APIs

### [Register for Push Notification](#tab/registerPushNotification)

- In order to register for push notification, application needs to call registerPushNotification() on a *CallAgent* instance with a device registration token.

### iOS (Swift)
```swift
let deviceToken: Data = pushRegistry?.pushToken(for: PKPushType.voIP)
callAgent.registerPushNotifications(deviceToken,
                withCompletionHandler: { (error) in
    if(error == nil) {
        print("Successfully register to push notification.")
    } else {
        print("Failed to register push notification.")
    }
})
```

### Android (Java)

- How to obtain the device resitration token
1. Make sure to add the Firebase SDK to your application module *build.gradle* by adding the following lines in the *dependencies* section if it's not already there
```
    // Add the SDK for Firebase Cloud Messaging
    implementation 'com.google.firebase:firebase-core:16.0.8'
    implementation 'com.google.firebase:firebase-messaging:20.2.4'
```

2. In your project level *build.gradle*, add the following in the *depoendencies* section if it's not already there
```
    classpath 'com.google.gms:google-services:4.3.3'
```

3. Add the following plugin to the beginning of the file if it's not already there
```
apply plugin: 'com.google.gms.google-services'
```

4. Select *Sync Now* in the toolbar

5. Add the following code snippet to get the device registration token generated by the FCM SDK for the client application instance 
- Add these import in the header of the main Activity for instance. They are required for the snippet to retrieve the token
```
import com.google.android.gms.tasks.OnCompleteListener;
import com.google.android.gms.tasks.Task;
import com.google.firebase.iid.FirebaseInstanceId;
import com.google.firebase.iid.InstanceIdResult;
```
- Add this snippet to retrieve the token
```
        FirebaseInstanceId.getInstance().getInstanceId()
                .addOnCompleteListener(new OnCompleteListener<InstanceIdResult>() {
                    @Override
                    public void onComplete(@NonNull Task<InstanceIdResult> task) {
                        if (!task.isSuccessful()) {
                            Log.w(TAG, "getInstanceId failed", task.getException());
                            return;
                        }

                        // Get new Instance ID token
                        String deviceToken = task.getResult().getToken();
                        // Log
                        Log.d(TAG, "Device Registration token retrieved successfully");
                    }
                });
```
6. Register the device registration token with the Calling Services SDK for incoming calls Push Notifications

```java
String deviceRegistrationToken = "some_token";
try {
    callAgent.registerPushNotification(deviceRegistrationToken).get();
}
catch(Exception e) {
    System.out.println("Something went wrong while registering for Incoming Calls Push Notifications.")
}
```

### [Push Notification Handling](#tab/handlePushNotification)

- In order to receive incoming calls push notifications, one has to call call *handlePushNotification()* on a *CallAgent* instance with a payload.

### iOS (Swift)
```swift
let dictionaryPayload = pushPayload?.dictionaryPayload
callAgent.handlePushNotification(dictionaryPayload
            , withCompletionHandler: { (error) in
            if (error != nil) {
                print("Handling of push notification failed")
            } else {
                print("Handling of push notification was successfull")
            }
        })
```

### Android (Java)

1. To obtain the payload from FCM, here are the necessary steps:
- Create a new Service (File > New > Service > Service) that extends the *FirebaseMessagingService* Firebase SDK class and make sure to override the *onMessageReceived* method. This method is event handler called when FCM delivers the push notification to the application.

```java
public class MyFirebaseMessagingService extends FirebaseMessagingService {
    private String pushNotificationMessageFormatted;

    @Override
    public void onMessageReceived(RemoteMessage remoteMessage) {
        // Check if message contains a notification payload.
        if (remoteMessage.getNotification() != null) {
            Log.d(TAG, "Message Notification Body: " + remoteMessage.getNotification().getBody());

            pushNotificationMessage = remoteMessage.getNotification().getBody();
        }
        else {
            pushNotificationMessage = serializeDictionaryAsJson(remoteMessage.getData());
        }
    }
}

public String serializeDictionaryAsJson(Map<String, String> fcmMessageDataMap) {
    // Add logic here to the dictionary into a string
    ...
    return jsonString;
}
```
- Also Add the following service definition to the AndroidManifest.xml file, inside the <application> tag.

```
        <service
            android:name=".MyFirebaseMessagingService"
            android:exported="false">
            <intent-filter>
                <action android:name="com.google.firebase.MESSAGING_EVENT" />
            </intent-filter>
        </service>
```

- Once the payload is retrieved, it can be passed to the *Communication Services* SDK to be handled by calling the *handlePushNotification* method on a *CallAgent* instance.

```java
String serializedPushNotificationMessageFromFCM = "some_jsonPayload";
try {
    callAgent.handlePushNotification(serializedPushNotificationMessageFromFCM).get();
}
catch(Exception e) {
    System.out.println("Something went wrong while handling the Incoming Calls Push Notifications.");
}
```
When the handling of the Push notification message is successfull, and the all events handlers are registered properly, the application will ring.

### [Unregister Push Notification](#tab/unregisterPushNotification)

- Applications can unregister push notification at any time. Simply call the `unregisterPushNotification()` method on callAgent.

### iOS (Swift)
```swift
callAgent.unRegisterPushNotifications(completionHandler: { (error) in
            if (error != nil) {
                print("Unregister of push notification failed, please try again")
            } else {
                print("Unregister of push notification was successfull")
            }
        })
```

### Android (Java)
```java
try {
    callAgent.unregisterPushNotifications().get();
}
catch(Exception e) {
    System.out.println("Something went wrong while unregistering for all Incoming Calls Push Notifications.")
}
```
